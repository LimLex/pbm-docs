# 选择性备份和恢复

!!! admonition "版本添加：[2.0.0](../release-notes/2.0.0.md)"

??? admonition "实现历史"

    下表列出了选择性备份实现中的更改以及引入这些更改的版本：

    | 版本            | 描述        |
    | ------------------ | ------------------ |
    | [2.0.3](../release-notes/2.0.3.md) | 支持分片集群中的非分片集合|
    | [2.1.0](../release-notes/2.1.0.md) | 添加了对分片集合的支持 |
    | [2.5.0](../release-notes/2.5.0.md) | 能够恢复带有用户和角色的数据库 |
    | [2.8.0](../release-notes/2.8.0.md) | 能够为备份定义多个命名空间 |
    | [2.8.0](../release-notes/2.8.0.md) | 能够以不同名称恢复单个非分片集合 |

您可以备份和恢复某些命名空间 - 数据库或集合。例如，如果您的 "Customers" 数据库中的 "Payments" 集合已损坏，您可以从完整备份中仅恢复此集合。或者，如果您的 "Invoices" 数据库包含敏感数据并且必须频繁备份，您可以配置仅备份此数据库。 

从版本 2.8.0 开始，您可以为备份定义多个数据库或集合。这简化了备份管理，因为您不是为每个命名空间创建备份，而是在单个备份中累积所需的数据。 

使用选择性备份和恢复，您只处理所需的数据子集，而不会中断整个集群的操作。 

您还大幅减少了整个数据集的备份/恢复操作时间，并节省了存储消耗。 

使用选择性备份和恢复功能，您有以下选项：

1.	备份单个数据库或特定集合并从中恢复所有数据。 
2.  备份某些数据库和/或集合并从中恢复完整数据或特定数据库/集合。
2.	从单个数据库备份恢复特定集合
3.	从完整备份恢复某些数据库和/或集合
4.	为指定的数据库/集合进行时间点恢复。仅适用于副本集。


## 分片集合

!!! admonition "版本添加：[2.1.0](../release-notes/2.1.0.md)"

您可以备份和恢复分片集合。在备份期间，每个分片上的 `pbm-agents` 保存指定数据库/集合的文档以及备份过程期间的完整 oplog。配置服务器副本集上的 `pbm-agent` 保存恢复所选命名空间所需的 `config` 数据库中的路由器配置文档。

在恢复期间，发生相反的过程：

* 每个分片上的 `pbm-agent` 仅恢复指定的数据库/集合，并重放仅与指定命名空间相关的 oplog。其他命名空间的操作将被忽略。
* 在配置服务器副本集上，`pbm-agent` 仅恢复指定分片集合的路由器配置。其他数据库、集合和块的路由器配置保持不变。

不支持分片时间序列集合的恢复。

请注意，选择性备份和恢复仅处理数据和路由器配置。集群配置和拓扑相关设置将被忽略。因此，我们建议在同一环境中恢复数据库/集合。

### 实现细节

在选择性恢复期间，数据库的主分片设置为备份时的状态。例如，备份期间数据库 "Staff" 的主分片是 A。恢复 "Staff" 数据库后，主分片将设置为 A，即使您在恢复之前将主分片从 A 移动到 B。所有非分片集合将在 A 上恢复；但是，它们不会从 B 中删除。您必须采取必要的操作（清理或将主分片移回 B）来维护它们。 

## 恢复带有用户和角色的数据库

!!! admonition "版本添加：[2.5.0](../release-notes/2.5.0.md)"

您可以恢复指定的数据库以及针对它们创建的用户和角色。此功能对于每个用户都有单独数据库并针对其进行身份验证的部署很有用。通过这种方式，您可以将所需的数据集恢复到数据损坏或丢失之前的状态。

考虑使用用户和角色的选择性恢复的这些细节：

* 您可以从完整备份恢复自定义数据库。 
* 用户和角色必须在自定义数据库中创建。出于安全考虑，在 `admin`、`config` 和 `local` 数据库中创建的用户不能成为选择性恢复的一部分。
* 如果恢复期间数据库中存在用户和角色，它们将从备份中覆盖。

## 以不同名称恢复集合

!!! admonition "版本添加：[2.8.0](../release-notes/2.8.0.md)"

您可以在当前集合旁边以不同名称恢复特定集合，直到某个时间点。这在您排查数据库问题并需要比较两个集合中的数据以确定导致数据库行为异常的原因时很有用。当您可以明确查看和编辑更改时，您可以深入了解数据并对其有自信的控制。因此，您的故障排除工作会显著减少。

在版本 2.8.0 中，您可以在副本集中以不同名称恢复单个非分片集合。对分片和时间序列集合的支持计划在未来的版本中提供。

要了解它的工作原理，请想象以下用例：

您注意到您的电子商务应用程序在订单上返回不正确或不完整的结果。您记得昨天一切正常，因此很可能是数据库的最近更改导致了问题。 

您有一个备份和完全覆盖前一天 2024-11-15 的 oplog 范围。

为了找出问题，您可以在当前 `orders` 集合旁边以不同名称恢复到指定时间，并比较它们。您决定恢复到 14:00。

```bash
pbm restore --time=2024-11-15T14:00:00 --ns-from=goods.orders --ns-to=goods.orders_prev
```

`orders_prev` 集合具有与 `orders` 集合相同的数据和索引。它还应用了与 `orders` 集合相同的 oplog 操作，允许您准确查看已更改的内容。

假设您发现 `status` 字段现在包含一个额外的 `date` 字段。这些更改未被注意到，应用程序的代码未更新以处理它们，导致不正确的结果。现在您已经确定了问题，可以采取必要的操作来修复它。

[已知限制](../features/known-limitations.md#selective-backups-and-restores){.md-button}
[创建备份](../usage/backup-selective.md){ .md-button .md-button }
[恢复备份](../usage/restore-selective.md){ .md-button .md-button }
