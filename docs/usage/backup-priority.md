# 调整备份的节点优先级

默认情况下，执行备份的 `pbm-agent` 在副本集的从节点中随机选择。在分片集群部署中，`pbm-agent` 在每个分片和配置服务器副本集的从节点中选择。如果在定义的时间内没有从节点响应，则选择主节点上的 `pbm-agent` 执行备份。

您可以通过在 Percona Backup for MongoDB [配置文件](../reference/config.md) 中为 `mongod` 节点分配优先级来影响 `pbm-agent` 选举。

```yaml
backup:
  priority:
    "localhost:28019": 2.5
    "localhost:27018": 2.5
    "localhost:27020": 2.0
    "localhost:27017": 0.1
```

优先级数组的格式是 `<hostname:port>`:`<priority>`。

!!! note

    使用配置文件是定义备份优先级的唯一方法。 

要在分片集群中定义优先级，您可以列出所有节点，或者为每个分片和配置服务器副本集中的一个节点指定优先级。`hostname` 和 `port` 唯一标识一个节点，以便 Percona Backup for MongoDB 识别它属于哪里并相应地授予优先级。

请注意，如果您仅列出特定节点，剩余节点将自动分配优先级 `1.0`。例如，您仅为分片集群的每个分片和配置服务器副本集中的一个从节点分配优先级 `2.5`。

```yaml
backup:
  priority:
    "localhost:27027": 2.5  # config server replica set
    "localhost:27018": 2.5  # shard 1
    "localhost:28018": 2.5  # shard 2
```

集群中剩余的从节点和主节点接收优先级 `1.0`。

优先级最高的 `mongod` 节点进行备份。如果此节点不可用，则选择下一个优先级节点。如果有多个具有相同优先级的节点，则随机选择其中一个进行备份。

如果您没有在配置中为 `priority` 选项列出任何节点，节点具有以下默认备份优先级：

* 隐藏节点 - 优先级 2.0
* 从节点 - 优先级 1.0
* 主节点 - 优先级 0.5

!!! important

    一旦您在配置文件中调整节点优先级，就假定您手动控制它们。优先选择从节点而不是主节点的默认规则停止工作。

    调整节点优先级会干扰增量备份的默认流程，其中 PBM 尝试在同一节点上安排增量备份，该节点创建了基础备份。如果您仅在优先级列表中列出节点的子集，剩余节点会收到默认优先级 1.0。这可能导致增量备份不是从创建基础备份的节点获取的。 

    要解决此问题，请在优先级列表中列出所有节点，或至少列出每个副本集中的一个节点。

这种调整节点优先级的能力通过选择特定节点或首选数据中心的节点来帮助您管理备份策略。在地理分布的基础设施中，您可以通过从地理位置最近的位置的节点进行备份来减少网络延迟。
