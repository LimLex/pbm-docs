# Percona Backup for MongoDB 2.12.0 ({{date.2_12_0}})

[Installation](../installation.md){.md-button}


Percona Backup for MongoDB 是一个分布式、低影响的解决方案，用于创建 MongoDB 分片集群和副本集的一致备份，并将这些备份恢复到特定时间点。

## 发布亮点

此版本专注于备份存储的改进。它包括新的存储类型，增强了 Azure 和 GCS 实现，并修复了 S3 兼容存储服务的问题。 

详细信息如下：

### 支持阿里云作为备份存储

**Percona Backup for MongoDB (PBM)** 现在支持**阿里云 OSS** 作为远程备份目标，您可以将备份工作流无缝集成到阿里云生态系统中。这意味着您可以直接在 OSS 中存储任何类型的备份，无需额外工具或手动步骤，充分利用阿里云的可扩展基础设施和强大的区域性能。 

您可以直接使用 OSS Access Key ID 和 Secret 进行身份验证，或者利用对阿里云安全令牌服务 (STS) AssumeRole 的完整支持，包括自动安全令牌刷新。后一种身份验证流程非常适合需要临时凭据以增强安全性的组织。 

此集成使已经投资阿里云的团队能够更好地采用 PBM。无论您是在亚太地区运营还是构建云原生基础设施，这都为您提供了一种安全、可扩展且合规的方式来保护您的数据。

### 确保在网络不稳定时也能将数据上传到 Azure Blob 存储

您现在可以在 PBM 配置中[控制上传到 Azure 的重试次数](../details/azure.md#upload-retries)。此增强功能确保您的数据到达目的地——即使网络不稳定或间歇性中断。通过自定义重试行为，您在备份和同步工作流中获得更大的弹性和可靠性。这是减少上传失败并提高安心度的简单方法。

### PBM 中的原生 MinIO 支持

PBM 现在通过添加 **MinIo Go 客户端库**包含对 MinIO 存储的原生支持。此集成使使用自定义 S3 兼容存储服务进行备份和恢复变得更加容易。 

并非所有 S3 兼容存储服务都支持 AWS SDK v2 中使用的签名版本 4 (SigV4)，这可能导致兼容性和连接问题。

为了解决这个问题，PBM 现在使用 MinIo Go 客户端，并在其配置中支持新的 `minio` 存储类型。 

```yaml
storage:
  type: minio
  minio:
    endpoint: minio.example.com:9000
    bucket: pbm-test-bucket
    prefix: data/pbm/backup
    credentials:
      access-key-id: <your-access-key-id-here>
      secret-access-key: <your-secret-key-here>
```

如果您的自定义 S3 兼容存储与 AWS SDK v2 不兼容，请考虑在升级后重新配置 PBM 以使用 `minio` 存储类型。但是，请注意使用 MinIO 存储类型的当前[已知限制](#known-limitation-for-using-the-minio-storage-type)。

#### 使用 MinIO 存储类型的已知限制

虽然 MinIo SDK 支持并发，但其实现会干扰 PBM 的备份逻辑并影响 PBM 功能。因此，目前 PBM 使用单线程上传备份，这导致备份性能比 S3 慢。我们正在积极研究在不影响可靠性的情况下提高吞吐量的安全方法。

### 弃用 Google Cloud Storage 的 HMAC 密钥支持

使用 HMAC 密钥访问 Google Cloud Storage 依赖于 AWS 签名版本 2 (SigV2)，这是一种已正式弃用的过时身份验证方法。Google Cloud Storage 不支持新的签名版本 4 (SigV4)，仅支持 SigV2 用于 HMAC 身份验证。

继续使用 SigV2 可能导致严重问题：Percona Backup for MongoDB 可能错误地将不完整的备份标记为成功，并将损坏的数据上传到存储。这会使您的恢复过程面临风险，并破坏备份可靠性。

不建议对 Google Cloud Storage 使用过时的签名版本 2 (SigV2) 身份验证，因为它缺乏重要的安全增强功能，不再维护，并且可能引入关键的可靠性问题。

为了防止这种情况，现在已弃用对 HMAC 密钥的支持。我们强烈建议迁移到使用 JSON 密钥的原生 GCS 连接类型 [:octicons-link-external-16:](https://cloud.google.com/iam/docs/keys-create-delete#creating)。请参阅[文档](../details/gcs.md#adjust-pbm-configuration-to-use-gcs) 以获取有关调整 PBM 配置以使用 JSON 密钥的指导。

我们将在 2026 年 4 月 30 日之后终止对 HMAC 的支持，并在 PBM 版本中删除它。


## 变更日志

### 新功能

- [PBM-1588](https://perconadev.atlassian.net/browse/PBM-1588) - Percona Backup for MongoDB 现在支持阿里云对象存储服务 (OSS) 作为远程备份存储（感谢 Imre Nagi 报告并贡献此功能）。

- [PBM-1631](https://perconadev.atlassian.net/browse/PBM-1631) - 使用 MinIO 客户端进行 S3 兼容存储以提高兼容性。


### 改进

- [PBM-1321](https://perconadev.atlassian.net/browse/PBM-1321) - 通过在备份过程中提供更清晰的状态消息改进了逻辑备份的 PBM 日志。

- [PBM-1593](https://perconadev.atlassian.net/browse/PBM-1593) - 现在自动恢复来自 Azure Blob 存储的中断下载，防止由于临时网络问题导致的恢复失败（感谢 Daniel Oliver 报告并贡献此问题）。

- [PBM-1628](https://perconadev.atlassian.net/browse/PBM-1628) - 现在对 Google Cloud Storage (GCS) 的备份对临时网络中断更具弹性。

## 已修复的错误

- [PBM-1093](https://perconadev.atlassian.net/browse/PBM-1093) - 添加了在连接问题时重试上传数据到 Azure Blob 存储的能力，确保可靠的备份。

- [PBM-1594](https://perconadev.atlassian.net/browse/PBM-1594) -  修复了在使用 HTTPS 连接与 MinIO 时由于数据块超过限制而导致备份无法上传的问题。通过添加 MinIO 客户端库修复了此问题（感谢 Rama Mekala 报告此问题）。

- [PBM-1605](https://perconadev.atlassian.net/browse/PBM-1605) - 修复了在网络中断期间以及使用 HMAC 密钥访问 Google Cloud Storage 时 PBM 将不完整备份错误标记为成功而不记录错误的问题。PBM 现在计算循环冗余校验 (CRC) 并将其与 GCS 生成的 CRC 进行比较，在不匹配时报告错误。 

- [PBM-1607](https://perconadev.atlassian.net/browse/PBM-1607) - 通过在日志中正确报告实际错误，修复了如果备份失败，已上传的文件仍保留在存储上的问题

- [PBM-1610](https://perconadev.atlassian.net/browse/PBM-1610) - 通过添加 MinIO Go 客户端库修复了由于 AWS SDK v2 中引入的新上传算法导致的自定义 S3 兼容存储数据上传问题，该库解决了自定义 S3 兼容存储服务的兼容性问题。

- [PBM-1619](https://perconadev.atlassian.net/browse/PBM-1619) - 通过在无效配置上引入基本检查并在检查失败时返回有意义的错误消息，修复了 PBM 因分段错误 (segfault) 失败的问题。（感谢 Neha Oudin 报告并贡献此问题）

- [PBM-1627](https://perconadev.atlassian.net/browse/PBM-1627) - GCS 存储重试配置现在正确解释时间单位（例如 '60s'），并包括新的 `ChunkRetryDeadline` 设置以管理上传超时。
