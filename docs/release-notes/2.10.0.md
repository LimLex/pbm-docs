# Percona Backup for MongoDB 2.10.0 ({{date.2_10_0}})

[Installation](../installation.md){.md-button}


Percona Backup for MongoDB 是一个分布式、低影响的解决方案，用于创建 MongoDB 分片集群和副本集的一致备份，并将这些备份恢复到特定时间点。

## 发布亮点

此版本提供以下功能和改进：

### 物理恢复的回退策略以确保集群运行

您现在可以配置 PBM 在物理恢复期间使用回退目录。在恢复开始时，PBM 将 `dbPath` 的内容复制到特殊的回退目录。然后，恢复按正常流程进行。 

如果恢复成功，PBM 删除回退目录。如果 PBM 检测到集群处于错误状态，它会触发回退过程并将集群恢复到恢复前的状态。这确保您的集群保持运行，允许您从另一个备份重试恢复或执行其他维护任务。

请注意，此功能需要在每个 `mongod` 实例上有足够的可用磁盘空间来存储 `dbPath` 的内容。在恢复开始时，PBM 检查可用磁盘空间并记录此信息。

使用此功能，即使在物理恢复期间发生错误，您的集群也可以保持运行。有关回退流程和配置的更多详细信息，请参阅[文档](../features/physical.md/#physical-restores-with-a-fallback-directory)。

### 通过更新的库改进安全性

Percona Backup for MongoDB 现在使用 AWS SDK v2 for Go，其中包括最新功能、安全更新和改进。这确保了与 AWS 服务的安全通信。

### 支持 Google Cloud Client 库

PBM 现在支持 Google Cloud Client Library 用于与 Google Cloud Storage (GCS) 交互。PBM 通过 JSON API 和 XML API 与 Google Cloud Storage (GCS) 通信。首选方法是使用服务账户的 JSON API。HMAC 密钥主要用于与 S3 样式 API 的兼容性。 

请注意，备份存储的 PBM 配置现在有一个专用的 `gcs` 子部分。如果您升级到 PBM 2.10.0 或更高版本，必须相应地更新备份配置：

1. 将 `storage.type` 从 `s3` 更改为 `gcs`。
2. 将 `storage.s3` 部分更改为 `storage.gcs` 并相应地调整参数。

在 [Google Cloud Storage (GCS)](../details/gcs.md) 章节中了解更多关于可用选项的信息。

此集成提供了改进的兼容性、更可预测的 API 响应以及对 GCS 功能的更好的长期支持。

## 打包更改

Percona Backup for MongoDB 不再支持 Ubuntu 20.04 (Focal Fossa)，因为此操作系统已达到生命周期结束。


## 变更日志

### 新功能

* [PBM-1506](https://perconadev.atlassian.net/browse/PBM-1506) - 添加对 GCS 单文件并发下载的支持

* [PBM-1507](https://perconadev.atlassian.net/browse/PBM-1507), [PBM-1511](https://perconadev.atlassian.net/browse/PBM-1511) - 添加使用回退目录进行物理恢复以确保集群运行的能力

### 改进

* [PBM-772](https://perconadev.atlassian.net/browse/PBM-772) - 使用 "hello" 命令而不是 "isMaster"

* [PBM-1474](https://perconadev.atlassian.net/browse/PBM-1474) - 将 AWS SDK API s3 从 v1 交换到 v2

* [PBM-1481](https://perconadev.atlassian.net/browse/PBM-1481) - 在 pbm list 和 pbm status 输出中删除恢复时间戳中的 "Z" 标记（感谢 Nathan Neulinger 报告此问题）

* [PBM-1484](https://perconadev.atlassian.net/browse/PBM-1484) - 使用专用的 Google Cloud Storage SDK Go 库而不是 AWS SDK v1

* [PBM-1498](https://perconadev.atlassian.net/browse/PBM-1498) - 为 GCS SDK 添加 HMAC 支持

* [PBM-1514](https://perconadev.atlassian.net/browse/PBM-1514) - 通过仅从存储检索最新记录并引入标志以检索完整历史来改进恢复的重新同步性能

* [PBM-1544](https://perconadev.atlassian.net/browse/PBM-1544) - 在 `pbm status` 输出中添加新的 "Status" 列以明确显示备份状态

### 已修复的错误

* [PBM-1238](https://perconadev.atlassian.net/browse/PBM-1238) - 修复了从元数据文件解析物理恢复状态时从集群心跳读取时间戳的错误。如果该字段在数据库中缺失、未初始化或格式不正确，解析将失败。如果元数据文件中存在时间戳，则通过处理时间戳来修复此问题

* [PBM-1401](https://perconadev.atlassian.net/browse/PBM-1401) - 为 `pbm config --file` 和 `pbm config --set` 命令添加了对 `--wait` 标志的支持。在运行这些命令后立即执行另一个操作（如启动备份）时，使用 `--wait` 标志是正确且推荐的方法，以确保在运行下一个命令之前存储完全同步

* [PBM-1439](https://perconadev.atlassian.net/browse/PBM-1439) 修复了由于在大小未知的实例的部分大小计算期间忽略 `maxUploadParts` 设置而导致备份失败的问题。通过使用 bytes/sec × duration 加上额外增长和 1 GiB 最小值来估算 oplog 切片大小来修复此问题（感谢 Rama Mekala 报告此问题）

* [PBM-1482](https://perconadev.atlassian.net/browse/PBM-1482) - 修复了由于未关闭的文件导致 S3 死锁以及由于单批处理导致 `config.chunks` 集合处理不完整而导致的选择性恢复问题

* [PBM-1483](https://perconadev.atlassian.net/browse/PBM-1483) - 通过在文件系统存储上并行删除和列出文件时添加适当的错误处理，修复了可能发生的未处理错误

* [PBM-1487](https://perconadev.atlassian.net/browse/PBM-1487) - 修复了如果目标集群具有备份中也存在的数据库且缓存未更新导致 `Time monotonicity violation` 错误，在完整逻辑恢复和从逻辑备份进行时间点恢复期间 mongos 失败的问题。通过引入清理阶段修复了此问题，在此期间 PBM 清理备份中存在的所有数据库和内部缓存，从而使集群为恢复过程的其余部分做好准备

* [PBM-1494](https://perconadev.atlassian.net/browse/PBM-1494) - 修复了 pbm status 输出中的 s3 URI 格式

* [PBM-1499](https://perconadev.atlassian.net/browse/PBM-1499) - 改进恢复元数据中的错误消息以包含实际错误而不是占位符

* [PBM-1501](https://perconadev.atlassian.net/browse/PBM-1501), [PBM-1531](https://perconadev.atlassian.net/browse/PBM-1531) - 修复了由于缓冲记录器内发生死锁而导致的增量恢复挂起问题（感谢 Danila Terekhov 报告此问题）

* [PBM-1502](https://perconadev.atlassian.net/browse/PBM-1502) - 修复了配置文件同步失败的问题

* [PBM-1519](https://perconadev.atlassian.net/browse/PBM-1519) - 通过删除当 MongoDB 作为物理恢复过程的一部分关闭时关于数据库连接错误的消息来修复物理恢复的日志记录

* [PBM-1522](https://perconadev.atlassian.net/browse/PBM-1522) - 通过检查完整数据库名称而不是前缀，修复了如果数据库名称以 `admin` 开头，在选择性恢复期间用户恢复不正确的问题（感谢 Tomasz Spyrka 报告此问题并为其做出贡献）

* [PBM-1523](https://perconadev.atlassian.net/browse/PBM-1523) - 修复了 PBM 的系统集合：`pbmCmd`、`pbmLog`、`pbmConfig` 未从选择性恢复中排除的问题（感谢 Tomasz Spyrka 报告此问题并为其做出贡献）

* [PBM-1538](https://perconadev.atlassian.net/browse/PBM-1538) - 修复了即使 oplog 上传失败，备份也被错误标记为成功的问题

* [PBM-1550](https://perconadev.atlassian.net/browse/PBM-1550) - 修复了尽管缺少指定时间的 oplog 块，PBM 仍启动时间点恢复的问题

* [PBM-1551](https://perconadev.atlassian.net/browse/PBM-1551) - 通过 `pbm-agent` 记住它看到的每个命令（按时间戳分组）并忽略共享时间戳和命令的重复，修复了 PBM 重新发出先前执行的命令的问题

* [PBM-1553](https://perconadev.atlassian.net/browse/PBM-1553) - 改进了物理恢复期间的 `mongod` 重启过程和日志记录，以修复在清理和重置副本集配置阶段失败的恢复

* [PBM-1564](https://perconadev.atlassian.net/browse/PBM-1564) - 通过改进存储身份检查，仅检查标识存储的属性（如区域、存储桶名称或前缀路径），修复了增量备份失败并出现错误 "source backup is stored on a different storage" 的问题


